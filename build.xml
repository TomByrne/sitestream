<?xml version="1.0" encoding="UTF-8"?>
<project name="site_stream" default="all">

	<!-- Setup build properties -->
	<target name="-init">
		<!-- External props -->
		<property environment="env"/>
	    <property file="${basedir}/build.user.properties" />
	    <property file="${basedir}/build.properties" />
		
		<!-- Flex SDK -->
		<property name="flex.sdk.lib" value="${flex.sdk.home}/lib" />
		<property name="flex.sdk.adt" value="${flex.sdk.lib}/adt.jar" />
		<property name="flex.sdk.compc" value="${flex.sdk.home}/bin/compc.exe" />
		
		<!-- General Source -->
		<property name="src.dir" value="${basedir}/siteStreamSrc" />
		<property name="test.src.dir" value="${basedir}/testSrc" />
		<property name="libs.dir" value="${basedir}/libs" />
		
		<!-- Build Config -->
		<property name="config.dir" value="${basedir}/config" />
		<property name="config.flex" value="${config.dir}/flex-config.xml" />
		
		<!-- General Build -->
		<property name="build.dir" value="${basedir}/build" />
		<property name="build.release.dir" value="${build.dir}/release" />
		<property name="build.release.swc" value="${build.release.dir}/siteStream.swc" />
		<property name="build.test.dir" value="${build.dir}/test" />
		<property name="build.test.reports.dir" value="${build.test.dir}/reports" />
		
		<!-- Flex tasks -->
		<property name="FLEX_HOME" value="${flex.sdk.home}" />
		<taskdef resource="flexTasks.tasks" classpath="${flex.sdk.home}/ant/lib/flexTasks.jar" />
		
		<!-- SWC Packager -->
		<taskdef name="swcpackager" classpath="${libs.dir}/SWCPackager.jar" 
				 classname="org.farmcode.antTasks.SWCPackager" />
		
		<!-- FlexUnit -->
		<taskdef resource="flexUnitTasks.tasks" 
				 classpath="${libs.dir}/flexUnitTasks-4.1.0_RC2-4.jar" />
	</target>
	
	<!-- Remove build artifacts -->
	<target name="clean" depends="-init">
		<delete dir="${build.dir}" />
	</target>
	
	<!-- Setup build artifacts directories -->
	<target name="-prepare" depends="clean">
		<mkdir dir="${build.dir}" />		
		<mkdir dir="${build.release.dir}" />		
		<mkdir dir="${build.test.dir}" />		
		<mkdir dir="${build.test.reports.dir}" />		
	</target>
	
	<!-- Run all tests and build a distributable -->
	<target name="all" depends="release" />
		
	<!-- Build a swc for the current library -->
	<target name="release" depends="test">
		<compc output="${build.release.swc}">
			<source-path path-element="${src.dir}" />			
			<include-sources dir="${src.dir}" includes="**/*.as" />			
			<external-library-path dir="${libs.dir}">
				<include name="*.swc"/>
			</external-library-path>
			<load-config filename="${config.flex}" />
			<external-library-path dir="${flex.sdk.home}/frameworks/libs/player/10.0">
				<include name="*.swc"/>
			</external-library-path>
		</compc>
	</target>
	
	<!-- Run all tests -->
	<target name="test" depends="-prepare">
		<flexunit workingDir="${build.test.dir}" toDir="${build.test.reports.dir}" 
				  haltonfailure="true" verbose="false" localTrusted="true">
			<source dir="${src.dir}" />
		    <testSource dir="${test.src.dir}">
				<!--<include name="**/*Test.as" />-->
				<include name="ExampleTest.as" />
			</testSource>
			<library dir="${libs.dir}" />
		</flexunit>

		<!-- Generate readable JUnit-style reports -->
		<junitreport todir="${build.test.reports.dir}">
			<fileset dir="${build.test.reports.dir}">
				<include name="TEST-*.xml" />
			</fileset>
			<report format="frames" todir="${build.test.reports.dir}/html" />
		</junitreport>
	</target>
	
</project>